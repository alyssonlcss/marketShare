<section class="module-shell propriedades-shell">
  <header class="module-shell__header">
    <div>
      <span class="eyebrow">Território</span>
      <h1>Inventário de Propriedades</h1>
      <p class="module-subtitle">Mapeie culturas, áreas e coordenadas para apoiar o planejamento regional.</p>
      <div class="filter-badge" *ngIf="atribuicaoFilter() === 'atribuido'">
        <span class="badge badge--atribuido">Atribuído</span>
      </div>
      <div class="filter-badge" *ngIf="atribuicaoFilter() === 'nao_atribuido'">
        <span class="badge badge--nao-atribuido">Não Atribuído</span>
      </div>
    </div>
  </header>

  <p-table
    #dtProps
    class="propriedades-table"
    [value]="propriedades()"
    [paginator]="true"
    [rows]="10"
    [showCurrentPageReport]="true"
    currentPageReportTemplate="{first} - {last} de {totalRecords} propriedades"
  >
    <ng-template pTemplate="header">
      <tr>
        <th pSortableColumn="nome">
          Nome
          <p-sortIcon field="nome"></p-sortIcon>
        </th>
        <th pSortableColumn="cultura">
          Cultura
          <p-sortIcon field="cultura"></p-sortIcon>
        </th>
        <th pSortableColumn="hectares">
          Hectares
          <p-sortIcon field="hectares"></p-sortIcon>
        </th>
        <th pSortableColumn="uf">
          UF
          <p-sortIcon field="uf"></p-sortIcon>
        </th>
        <th pSortableColumn="cidade">
          Cidade
          <p-sortIcon field="cidade"></p-sortIcon>
        </th>
        <th pSortableColumn="latitude">
          Latitude
          <p-sortIcon field="latitude"></p-sortIcon>
        </th>
        <th pSortableColumn="longitude">
          Longitude
          <p-sortIcon field="longitude"></p-sortIcon>
        </th>
        <th class="actions-col">Ações</th>
      </tr>
      <tr>
        <th>
          <input
            pInputText
            type="text"
            (input)="dtProps.filter($any($event.target).value, 'nome', 'contains')"
            placeholder="Filtrar nome"
          />
        </th>
        <th>
          <input
            pInputText
            type="text"
            (input)="dtProps.filter($any($event.target).value, 'cultura', 'contains')"
            placeholder="Filtrar cultura"
          />
        </th>
        <th>
          <input
            pInputText
            type="text"
            (input)="dtProps.filter($any($event.target).value, 'hectares', 'equals')"
            placeholder="Filtrar hectares"
          />
        </th>
        <th>
          <p-select
            [options]="ufOptions"
            placeholder="Filtrar UF"
            [showClear]="true"
            (onChange)="dtProps.filter($event.value, 'uf', 'equals')"
          ></p-select>
        </th>
        <th>
          <p-select
            [options]="cidadeOptions"
            placeholder="Filtrar cidade"
            [showClear]="true"
            [filter]="true"
            filterPlaceholder="Buscar cidade"
            (onChange)="dtProps.filter($event.value, 'cidade', 'equals')"
          ></p-select>
        </th>
        <th>
          <input
            pInputText
            type="text"
            (input)="dtProps.filter($any($event.target).value, 'latitude', 'contains')"
            placeholder="Filtrar latitude"
          />
        </th>
        <th>
          <input
            pInputText
            type="text"
            (input)="dtProps.filter($any($event.target).value, 'longitude', 'contains')"
            placeholder="Filtrar longitude"
          />
        </th>
        <th></th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-prop>
      <tr (click)="onRowClick(prop)">
        <td>{{ prop.nome }}</td>
        <td>{{ prop.cultura }}</td>
        <td>{{ prop.hectares }}</td>
        <td>{{ prop.uf }}</td>
        <td>{{ prop.cidade }}</td>
        <td>{{ prop.latitude }}</td>
        <td>{{ prop.longitude }}</td>
        <td class="actions">
          <button type="button" class="text-btn" (click)="edit(prop); $event.stopPropagation()">Editar</button>
          <button
            type="button"
            class="text-btn text-btn--danger"
            (click)="delete(prop); $event.stopPropagation()"
          >
            Excluir
          </button>
        </td>
      </tr>
    </ng-template>
  </p-table>

  <section class="lead-drawer" *ngIf="selectedLead && selectedPropriedade">
    <header class="lead-drawer__header">
      <div>
        <span class="eyebrow">Lead associado</span>
        <h2>{{ selectedLead.nome }}</h2>
        <p class="lead-drawer__subtitle">
          {{ selectedPropriedade.cidade }}/{{ selectedPropriedade.uf }} ·
          {{ selectedPropriedade.cultura }} · {{ selectedPropriedade.hectares | number: '1.0-0' }} ha
        </p>
      </div>
      <div class="lead-drawer__actions">
        <button type="button" class="module-primary-btn" (click)="openNewForLead()">Nova propriedade</button>
        <button type="button" class="text-btn" (click)="closeDrawer()">Fechar</button>
      </div>
    </header>

    <div class="lead-drawer__content">
      <div class="lead-drawer__info">
        <p><strong>Telefone:</strong> {{ selectedLead.telefone || '—' }}</p>
        <p><strong>Email:</strong> {{ selectedLead.email || '—' }}</p>
        <p><strong>Status:</strong> {{ selectedLead.status }}</p>
      </div>
    </div>
  </section>

  <p-dialog
    [(visible)]="dialogVisible"
    [modal]="true"
    [draggable]="false"
    [resizable]="false"
    [style]="{ width: '640px' }"
    [contentStyle]="{ background: 'rgba(6,18,13,0.95)', borderRadius: '20px', 'min-height': '70vh', 'max-height': '90vh', 'overflow-y': 'auto' }"
    [header]="editing ? 'Editar Propriedade' : 'Nova Propriedade'"
  >
    <form (ngSubmit)="save()" #propForm="ngForm" class="dialog-form">
      <label class="dialog-field">
        <span>Nome</span>
        <input type="text" name="nome" required [(ngModel)]="formModel.nome" />
      </label>

      <label class="dialog-field">
        <span>Cultura</span>
        <input type="text" name="cultura" required [(ngModel)]="formModel.cultura" />
      </label>

      <label class="dialog-field">
        <span>Hectares</span>
        <input type="number" min="0" name="hectares" required [(ngModel)]="formModel.hectares" />
      </label>

      <label class="dialog-field">
        <span>UF</span>
        <p-select
          name="uf"
          [options]="ufList"
          optionLabel="nome"
          optionValue="sigla"
          placeholder="Selecione o estado"
          [showClear]="true"
          required
          [(ngModel)]="formModel.uf"
          (onChange)="onUfChange($event.value)"
        ></p-select>
      </label>

      <label class="dialog-field">
        <span>Cidade</span>
        <p-select
          name="cidade"
          [options]="cidadeFormOptions"
          optionLabel="nome"
          optionValue="nome"
          placeholder="Selecione a cidade"
          [showClear]="true"
          [filter]="true"
          filterPlaceholder="Buscar cidade"
          required
          [(ngModel)]="formModel.cidade"
        ></p-select>
      </label>

      <div class="dialog-field__grid">
        <label class="dialog-field">
          <span>Latitude</span>
          <input
            type="number"
            name="latitude"
            required
            min="-90"
            max="90"
            step="0.000001"
            [(ngModel)]="formModel.latitude"
          />
        </label>
        <label class="dialog-field">
          <span>Longitude</span>
          <input
            type="number"
            name="longitude"
            required
            min="-180"
            max="180"
            step="0.000001"
            [(ngModel)]="formModel.longitude"
          />
        </label>
      </div>

      <div class="dialog-actions">
        <button type="button" class="text-btn" (click)="dialogVisible = false">Cancelar</button>
        <button type="submit" class="module-primary-btn" [disabled]="propForm.invalid">Salvar</button>
      </div>
    </form>
  </p-dialog>

  <p-dialog
    [(visible)]="errorDialogVisible"
    [modal]="true"
    [closable]="true"
    [dismissableMask]="true"
    [style]="{ width: '420px' }"
    [contentStyle]="{ background: 'rgba(6,18,13,0.95)', borderRadius: '20px' }"
    header="Ocorreu um erro"
  >
    <div class="dialog-form">
      <p>{{ errorMessage }}</p>
      <div class="dialog-actions">
        <button type="button" class="module-primary-btn" (click)="errorDialogVisible = false">OK</button>
      </div>
    </div>
  </p-dialog>
</section>
