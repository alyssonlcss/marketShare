<section class="module-shell leads-shell">
  <header class="module-shell__header">
    <div>
      <span class="eyebrow">Relacionamento</span>
      <h1>Pipeline de Leads</h1>
      <p class="module-subtitle">Organize contatos, estágios e próximos passos sem tirar os pés do campo.</p>
      <div class="filter-badge" *ngIf="atribuicaoFilter() === 'atribuido'">
        <span class="badge badge--atribuido">Atribuído</span>
      </div>
      <div class="filter-badge" *ngIf="atribuicaoFilter() === 'nao_atribuido'">
        <span class="badge badge--nao-atribuido">Não Atribuído</span>
      </div>
    </div>
    <button type="button" class="module-primary-btn" (click)="openNew()">Novo lead</button>
  </header>

  <p-table
    #dtLeads
    class="leads-table"
    [value]="leads()"
    [paginator]="true"
    [rows]="10"
    [showCurrentPageReport]="true"
    currentPageReportTemplate="{first} - {last} de {totalRecords} leads"
  >
    <ng-template pTemplate="header">
      <tr>
        <th pSortableColumn="nome">
          Nome
          <p-sortIcon field="nome"></p-sortIcon>
        </th>
        <th pSortableColumn="cpf">
          CPF
          <p-sortIcon field="cpf"></p-sortIcon>
        </th>
        <th pSortableColumn="email">
          Email
          <p-sortIcon field="email"></p-sortIcon>
        </th>
        <th pSortableColumn="telefone">
          Telefone
          <p-sortIcon field="telefone"></p-sortIcon>
        </th>
        <th pSortableColumn="status">
          Status
          <p-sortIcon field="status"></p-sortIcon>
        </th>
        <th class="actions-col">Ações</th>
      </tr>
      <tr>
        <th>
          <input
            pInputText
            type="text"
            (input)="dtLeads.filter($any($event.target).value, 'nome', 'contains')"
            placeholder="Filtrar nome"
          />
        </th>
        <th>
          <input
            pInputText
            type="text"
            (input)="dtLeads.filter($any($event.target).value, 'cpf', 'contains')"
            placeholder="Filtrar CPF"
          />
        </th>
        <th>
          <input
            pInputText
            type="text"
            (input)="dtLeads.filter($any($event.target).value, 'email', 'contains')"
            placeholder="Filtrar email"
          />
        </th>
        <th>
          <input
            pInputText
            type="text"
            (input)="dtLeads.filter($any($event.target).value, 'telefone', 'contains')"
            placeholder="Filtrar telefone"
          />
        </th>
        <th>
          <p-select
            [options]="statusOptions"
            optionLabel="label"
            optionValue="value"
            placeholder="Filtrar status"
            [showClear]="true"
            (onChange)="dtLeads.filter($event.value, 'status', 'equals')"
          ></p-select>
        </th>
        <th></th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-lead>
      <tr>
        <td>{{ lead.nome }}</td>
        <td>{{ lead.cpf }}</td>
        <td>{{ lead.email }}</td>
        <td>{{ lead.telefone }}</td>
        <td><span class="tag-pill">{{ lead.status }}</span></td>
        <td class="actions">
          <button type="button" class="text-btn" (click)="editLead(lead)">Editar</button>
          <button type="button" class="text-btn text-btn--danger" (click)="deleteLead(lead)">Excluir</button>
        </td>
      </tr>
    </ng-template>
  </p-table>

  <p-dialog
    [(visible)]="dialogVisible"
    [modal]="true"
    [draggable]="false"
    [resizable]="false"
    [style]="{ width: '640px' }"
    [contentStyle]="{ background: 'rgba(6,18,13,0.95)', borderRadius: '20px', 'min-height': '70vh', 'max-height': '90vh', 'overflow-y': 'auto' }"
    [header]="editingLead ? 'Editar Lead' : 'Novo Lead'"
  >
    <form (ngSubmit)="save()" #leadForm="ngForm" class="dialog-form">
      <label class="dialog-field">
        <span>Nome</span>
        <input type="text" name="nome" required [(ngModel)]="formModel.nome" />
      </label>

      <label class="dialog-field" *ngIf="!editingLead">
        <span>CPF</span>
        <input type="text" name="cpf" required [(ngModel)]="formModel.cpf" (blur)="onCpfBlur()" />
      </label>

      <label class="dialog-field">
        <span>Email</span>
        <input type="email" name="email" required [(ngModel)]="formModel.email" />
      </label>

      <label class="dialog-field">
        <span>Telefone</span>
        <input
          type="text"
          name="telefone"
          required
          pattern="^[+0-9 ()-]{10,20}$"
          [(ngModel)]="formModel.telefone"
          (blur)="onTelefoneBlur()"
        />
      </label>

      <label class="dialog-field">
        <span>Comentário</span>
        <input type="text" name="comentario" [(ngModel)]="formModel.comentario" />
      </label>

      <label class="dialog-field">
        <span>Status</span>
        <p-select
          name="status"
          [options]="statusOptions"
          optionLabel="label"
          optionValue="value"
          [(ngModel)]="formModel.status"
        ></p-select>
      </label>

      <div>
        <h4>{{ editingLead ? 'Propriedade rural do lead' : 'Propriedade rural (obrigatória)' }}</h4>

        <label class="dialog-field">
          <span>Nome da propriedade</span>
          <input
            type="text"
            name="propNome"
            [required]="!editingLead"
            [(ngModel)]="formModel.propriedade.nome"
          />
        </label>

        <label class="dialog-field">
          <span>Cultura</span>
          <input
            type="text"
            name="propCultura"
            [required]="!editingLead"
            [(ngModel)]="formModel.propriedade.cultura"
          />
        </label>

        <label class="dialog-field">
          <span>Hectares</span>
          <input
            type="number"
            name="propHectares"
            [required]="!editingLead"
            min="0"
            [(ngModel)]="formModel.propriedade.hectares"
          />
        </label>

        <label class="dialog-field">
          <span>UF</span>
          <p-select
            name="propUf"
            [options]="ufList"
            optionLabel="nome"
            optionValue="sigla"
            placeholder="Selecione o estado"
            [showClear]="true"
            [required]="!editingLead"
            [(ngModel)]="formModel.propriedade.uf"
            (onChange)="onPropriedadeUfChange($event.value)"
          ></p-select>
        </label>

        <label class="dialog-field">
          <span>Cidade</span>
          <p-select
            name="propCidade"
            [options]="cidadeFormOptions"
            optionLabel="nome"
            optionValue="nome"
            placeholder="Selecione a cidade"
            [showClear]="true"
            [filter]="true"
            filterPlaceholder="Buscar cidade"
            [required]="!editingLead"
            [(ngModel)]="formModel.propriedade.cidade"
          ></p-select>
        </label>

        <div class="dialog-field__grid">
          <label class="dialog-field">
            <span>Latitude</span>
            <input
              type="number"
              name="propLatitude"
              [required]="!editingLead"
              min="-90"
              max="90"
              step="0.000001"
              [(ngModel)]="formModel.propriedade.latitude"
            />
          </label>
          <label class="dialog-field">
            <span>Longitude</span>
            <input
              type="number"
              name="propLongitude"
              [required]="!editingLead"
              min="-180"
              max="180"
              step="0.000001"
              [(ngModel)]="formModel.propriedade.longitude"
            />
          </label>
        </div>
      </div>

      <div class="dialog-actions">
        <button type="button" class="text-btn" (click)="dialogVisible = false">Cancelar</button>
        <button type="submit" class="module-primary-btn" [disabled]="leadForm.invalid">Salvar</button>
      </div>
    </form>
  </p-dialog>
</section>
